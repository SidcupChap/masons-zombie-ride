// api/createZombieVehicle.ts
import { GoogleGenAI } from "@google/genai";

export default async function handler(req: any, res: any) {
  try {
    if (req.method !== "POST") {
      res.status(405).json({ error: "Method not allowed" });
      return;
    }

    const { baseImage, mode } = req.body || {};

    if (!baseImage || !mode) {
      res.status(400).json({ error: "Missing baseImage or mode" });
      return;
    }

    const apiKey = process.env.GEMINI_API_KEY;
    if (!apiKey) {
      res.status(500).json({ error: "Missing GEMINI_API_KEY on server" });
      return;
    }

    const ai = new GoogleGenAI({ apiKey });

    const instruction = `
      You are a legendary visual effects artist for a Zombie Apocalypse movie.
      Your client is "COMMANDER MASON", the leader of the resistance.

      YOUR GOAL: Transform the input vehicle into a battle-ready machine.

      MANDATORY REQUIREMENT: The name "MASON" must be visible on the vehicle or background.
      - As a metal plate welded to the door.
      - As a neon sign reflecting in a puddle.
      - As graffiti spray-painted on the armor.

      MODE: ${String(mode).toUpperCase()}
      - "apocalypse" → More spikes, armor, weapons, chaos
      - "neon" → Bright neon lights, cyberpunk, energy
      - "military" → Heavy plating, real weapons, realistic details

      The final output must resemble a highly detailed, cinematic movie still.
    `;

    const model = ai.getGenerativeModel({
      model: "gemini-2.0-flash-exp",
      generationConfig: {
        temperature: 0.9,
        maxOutputTokens: 2048,
      },
    });

    const result = await model.generateContent([
      {
        role: "user",
        parts: [
          { text: instruction },
          {
            inlineData: {
              data: String(baseImage).split(",")[1],
              mimeType: "image/jpeg",
            },
          },
        ],
      },
    ]);

    const output = await result.response;
    const candidates = output.candidates;

    if (!candidates || candidates.length === 0) {
      res.status(500).json({ error: "No response from Gemini" });
      return;
    }

    const parts = candidates[0].content?.parts || [];
    const imagePart = parts.find(
      (p: any) => p.inlineData && p.inlineData.data
    );

    if (!imagePart) {
      res.status(500).json({ error: "No image generated by the model" });
      return;
    }

    const mimeType = imagePart.inlineData.mimeType || "image/png";
    const data = imagePart.inlineData.data;

    res.status(200).json({
      image: `data:${mimeType};base64,${data}`,
    });
  } catch (error: any) {
    console.error("Gemini API Error:", error);
    res.status(500).json({ error: String(error) });
  }
}
